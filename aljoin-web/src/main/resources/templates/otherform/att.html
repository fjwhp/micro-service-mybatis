<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>考勤审批</title>
<link rel="stylesheet" href="/getCssStyle?css=static/web/plugins/layui/css/layui.css" media="all" />
<link rel="stylesheet" href="../../web/css/global.css" media="all">
<link rel="stylesheet" href="../../web/css/zTreeStyle.css" media="all">
<link rel="stylesheet" href="../../web/plugins/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="../../web/css/table.css" />
<link rel="stylesheet" href="/getCssStyle?css=static/web/plugins/layui2/css/layui.css" />
<link rel="stylesheet" href="../../web/css/public.css" media="all">
<link rel="stylesheet" href="../../web/css/zhengls.css" media="all">
<link rel="stylesheet" href="../../web/css/multsel.css" media="all">
<style>
	.thisweek{width:10px;height:20px;background:#ff5454;margin-right:6px;float:left;}
	.table_sty{width:50%;margin-left:15px;margin-top:14px;height: 400px;overflow: auto;}
	.blue_border{border:solid 1px #339bf1;}
    div#audit-member-list a:hover {
        background-color:#f1f1f1;
    }
</style>
</head>
<body>

		<!-- 考勤补签 -->
	<div id="auth-div" style="padding-left: 10px; padding-right: 10px;">
		
		<form class="layui-form" id="heheda" action="" style="padding-top:40px;">
		  <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" id="${_csrf.parameterName}" />
			<input type="hidden" id="bizId" value="${bizId}">
			<input type="hidden" id="bizType" value="${bizType}">
			<input type="hidden" id="taskId" value="${taskId}">
			<!-- 用于显示在办详情 -->
			<input type="hidden" id="processInstanceId" value="${processInstanceId}">
			<!-- 如果是流转监控过来的 该参数值为1 用于隐藏撤回按钮 -->
			<input type="hidden" id="isMonitor" value="${isMonitor}">
		  <div id="formDiv">
		       
		  </div>
		  
		  <div style="width:100%;height:80px;text-align:center;line-height:40px;margin-bottom:40px;">
		       <h1 style="font-size: 20px; font-weight: 600;margin-top:10px"> <img  style="position: relative;top: -3px;" src="../../web/images/RegisterIco.png" />补签申请</h1>
		      <div style="margin">
		       <span>申请人：</span>
		       <span style="margin-right:40px" id="signUserName"></span>
		       <span>部门：</span>
		       <span style="margin-right:40px" id="deptName"></span>
		       <span>起草时间：</span>
		       <span id="timeqi"></span>
		      </div>
		      
		  </div> 
				 <table class="layui-table butable">
					<colgroup>
				     <col width="20%">
				      <col width="20%">
				      <col width="30%">
						<col width="30%">
  					</colgroup>
				  <thead>
				    <tr>
				      <th>时间</th>
				      <th>状态</th>
				      <th>打卡信息</th>
				      <th>原因</th>
				    </tr> 
				  </thead>
					 <tbody id="patch-data">
					 <script id="patch-script" type="text/html">
						 {{each patchlist value index}}
						 <tr >
							 <td>{{value.signDateStr}}</td>
							 <td>{{value.patchStatus}}</td>
							 <td>{{value.signPatchDate}}</td>
							 <td style="white-space: initial;" title="{{value.patchReason}}">{{value.patchReason}}</td>
						 </tr>
						 {{/each}}
					 </script>
					 </tbody>
			 </table>
	
			<div class="btn_fixed_top" id="btns">
				<!-- <div style="float:left;">
			        <a href="javascript:void(0)" class="layui-btn layui-btn-primary" onclick="parent.layer.closeAll()"><i class="fa fa-backward "></i> 返回</a>
			    </div> 
				<div class="r">-->
				<div>
					<a class="flow_btn act" style="display:none;" onclick="yes()" id="sub"><i class="layui-icon">&#xe6c6;</i>提交</a>
					<a class="flow_btn " onclick="change_btn()" id="sign"><i class="layui-icon">&#xe6b2;</i>签收</a>
					<a class="flow_btn btns" onclick="fixed.print('heheda')"><i class="layui-icon">&#xe621;</i>打印</a>
					<a class="flow_btn btns " style="display:none;"onclick="fixed.showImg()"><i class="layui-icon">&#xe62c;</i>流程图</a>
					<a class="flow_btn btns" onclick="daily()"><i class="layui-icon">&#xe60a;</i>流转日志</a>
					<a class="flow_btn " id="revoke"><i class="layui-icon">&#xe6b2;</i>撤回</a>
					<a class="flow_btn act" style="display:none;" id="void-process"><i class="layui-icon">&#xe640;</i>作废</a>
				</div>
			</div>
		</form>
	</div>
	<!-- 日志 -->
	<div class="" id="win-daily-object" style="display:none;">
		<form class="layui-form layui-form-pane admin-main">
			<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
			<div class="layui-form">
				  <table class="layui-table admin-table">
				  	  <colgroup>
					      <col width="10%">
					      <col width="20%">
					      <col width="10%">
					      <col width="15%">
					      <col width="45%">
					      <col>
					  </colgroup>
					<thead>
						<tr>
							<th style="display: none;">用户ID</th>
							<th>操作人</th>
							<th>流程方向</th>
							<th>接收人</th>
							<th>操作时间</th>
							<th>审核意见</th>
						</tr>
					</thead>
					<tbody id="paging2-data">
					<script id="paging2-script" type="text/html">
						{{each loglist value index}}
						<tr >
							<td style="display: none;">{{value.taskId}}</td>
							<td title="{{value.operationName}}">{{value.operationName}}</td>
							<td title="{{value.direction}}">{{value.direction}}</td>
							<td title="{{value.recevieUserName}}">{{value.recevieUserName}}</td>
							<td>{{value.operationTime}}</td>
							<td style="white-space:normal;word-wrap: break-word;">{{value.comment}} </td>
						</tr>
						{{/each}}
					</script>
					</tbody>
					</table>
			  </div>
			  <div class="admin-table-page" style="border-width: 0px; z-index: 0;">
					<div id="paging-footer" class="page" style="background-color: white; text-align: center;"></div>
			  </div>
		</form>
	</div>
	<!-- 审批填写意见弹窗 -->
	<div class="" id="win-suggest-object" style="display:none;">
		<form class="layui-form" id="win-suggest-form" style="margin:10px 0 10px 10px">
		<div class="judge_div">
		<div class="l" style="width:58%;">
			<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
						<div class="layui-form-item">
				<label class="layui-form-label" style="font-weight:bold;width:111px;">审批选择：</label>
				<div class="layui-input-block">
					<a class="layui-btn layui-btn-primary blue_border yes judge_btn" onclick="agree()">同意</a>
					<a class="layui-btn layui-btn-primary no judge_btn" onclick="noagree()" id="no_agree_btn">回退</a>
				</div>
			</div>
			<div class="agree">
				 <div class="layui-form-item">
					<label class="l" style="margin-left:14px;font-weight:bold;">下一级审批环节：</label>
					<!-- <label style="margin-left:14px;">审批</label> -->
					<div class="layui-input-inline" style="z-index:2001;">
					   <select name="nextNode" lay-verify="" id="nextNode">
					    </select>
					</div>
				</div>
				<div class="layui-form-item">
					<!-- option1 -->
					<div id="audit-orgn">
						<label class="l" style="font-weight:bold;">下一级审批处理人：</label>
						<div class="l" style="width:73%"> 
							<div id="n_receiverName" class="judge input_btn reset1" readonly="readonly"></div>
							<a class="btn_blue2 r m_t10" onclick="personlSeclectOpen()">请选择</a>
							<input type="hidden" name="receiverId"  id="n_receiverNameid" class="reset">
                            <input type="hidden"   id="n_receiverName_" class="reset">
							<input type="hidden"   id="deptId" class="reset">
							<input type="hidden" id="deptUserId" class="reset">
							<input type="hidden" id="openType" value = "1">
							<input type="hidden" id="isNotEnd" class="reset" value="1"><!-- 值为0是结束节点 -->
							<input type="hidden" id="nextStept" class="reset"> <!-- 分支节点条件 -->
						</div>
					</div>
					
					<!-- option2 -->
					<div class="m_t10" id="audit-member">
						<div class="multsel l" defval="0">
							<span class="view" style="font-weight:bold;">下一级审批处理人：</span>
							<div class="selist" id="audit-member-list">
							</div>
						</div>
						<div id="testarea" class="judge1 input_btn reset1 l" readonly="readonly"></div>
					</div>
				</div>
			</div>
			
			<div class="noagree" style="display:none">
			<!-- 	<div class="layui-form-item">
					<label class="layui-form-label" title="回退到申请人">回退</label>
					<div class="layui-input-block">
						<input type="text" name="" id="" lay-verify="spactily" placeholder="回退到申请人"  autocomplete="off" class="layui-input">
					</div>
				</div> -->
				<div class="layui-form-item">
					<label class="l" style="margin-left:27px;font-weight:bold;">回退到上一级：</label>
					<!-- <label style="margin-left:14px;">审批</label> -->
					<div class="layui-input-inline" style="z-index:2001;">
					   <!--<select name="city" lay-verify="">

					    </select>-->
						<span id="pre-nodeName"></span>
					</div>
				</div>
			</div>
		<!-- 	<div class="layui-form-item layui-form-text">
				<label class="layui-form-label">审批意见</label>
				<div class="layui-input-block">
					 <textarea name="" id="comment"   class="layui-textarea"></textarea>
				</div>
			</div>
			<div class="layui-form-item">
				<a href="#" style="float:right;color:blue;">使用常用意见</a>
			</div> -->

				<label style="font-weight:bold;">意见：</label>
				<textarea id="draw_sug" style="height:100px;width:97%;margin-top:5px;" maxlength="95" onkeyup="countnum(this);"></textarea>
				<div class="r hand" onclick="add_sug()"><span class="table_btn"><small  style="color:#333;margin-right:20px;"><span id="count">0</span>/95</small>加入常用意见</span></div>
			</div>
			<div class="layui-form l judge_table" style="width:40%;">
				  <table class="layui-table admin-table">
				  	  <colgroup>
					      <col width="15%">	
					      <col width="85%">
					      <col>
					  </colgroup>
					<thead>
						<tr>
							<th>序号</th>
							<th>常用意见</th>
						</tr>
					</thead>
					<tbody id="opinion-data">
					<script id="opinion-script" type="text/html">
					{{each opinionlist value index}}
					<tr >
						<td>{{index+1}}</td>
						<td title="" class="hand" onclick="click_font(this)"><p class="hand sug" style="white-space: normal;">{{value.content}}</p></td>
					</tr>
					{{/each}}
					</script>
					</tbody>
					</table>
			  </div>
			</div>  
			<div class="judge_fixed" style="margin:10px 0;">
				<a href="javascript:void(0)" class="layui-btn layui-btn-primary" onclick="layer.closeAll();" style="margin-right:10px;"><i class="fa fa-backward"></i> 返回</a>
				<div style="float: right;margin-right:15px;">
					<button class="layui-btn" lay-submit="" lay-filter="form-add-submit" id="form-add-submit">
						<i class="fa fa-save"></i> 确认
					</button>
				</div>
				<div style="float: right;margin-right:15px;">
					<button class="layui-btn" lay-submit="" lay-filter="form-jump-submit" style="display: none" id="form-jump-submit">
						<i class="fa fa-save"></i> 确认
					</button>
				</div>
			</div>
		</form>
	</div>
	<!-- 人员选择树 -->
	<div style="display: none;z-index: 19940200;" id="win-personal-object">
		<div class="search_h">
			<input id="peopelSel" class="tree_search1 reset" type="text" value="" placeholder="搜索">
			<a class="layui-btn layui-btn-small" id="" onclick="searchNodes()"><i class="layui-icon">&#xe615;</i>搜索</a>
			<a class="layui-btn layui-btn-small layui-btn-primary" style="margin-left:2px;" type="reset" onclick="reset_tree()"><li class="fa fa-eraser"></li> 重置</a>
			<label type="text"  id="resultKey" class="form-control">  
                <div>  
                    <a id="clickUp" class="tree_up" onclick="clickUp()"><i class="layui-icon">&#xe619;</i></a>  
                    <a id="clickDown" class="tree_down" onclick="clickDown()"><i class="layui-icon">&#xe61a;</i></a>  
                </div>  
                <label id="number" class="tree_number"></label>  
            </label>  
        </div>
        <div class="tree_h">
        	<ul id="treeDemo" class="ztree treeDemo1" name="treeDemo" style="display:block"></ul>
        </div>
        <div class="sure_h">
		    <a class="layui-btn layui-btn-small sure_s"><li class="fa fa-save"></li> 确定</a>
		</div>
	</div>
	<script type="text/javascript" src="../../web/plugins/layui2/layui.js"></script>
	<script type="text/javascript" src="../../web/plugins/layui/lay/modules/laypage.js"></script>
	<script type="text/javascript" src="../../web/js/template-web.js"></script>
	<script type="text/javascript" src="../../web/js/jquery.js"></script>
	<script type="text/javascript" src="../../web/js/tool_upload.js"></script>
    <script type="text/javascript" src="../../web/js/jquery.ztree.all.min.js"></script>
	<script type="text/javascript" src="../../web/js/laydate/laydate.js"></script>
	<script type="text/javascript" charset="utf-8" src="../../web/js/multsel.js"></script>
	<script type="text/javascript" charset="utf-8" src="../../web/js/fixedform.js"></script>
	<script>
        //定义layui
        var taskId = $("#taskId").val();
        var bizId = $("#bizId").val();
        var _csrf = $("#_csrf").val();
        var  processInstanceId= $("#processInstanceId").val();    
        var pform;
        layui.use(['form','element'], function() {
            pform = layui.form;
            /*审批完成任务*/
            var nextStept = $("#nextStept").val();
            fixed.completeTask("form-add-submit","/att/attSignInOut/completeTask",taskId,_csrf,bizId,nextStept,"heheda");
            /*填写意见
            fixed.addComment("form-savecomment-submit",taskId,_csrf,$("#draw_sug").val());*/
            /*回退到上一节点*/
            fixed.jump2Task2("form-jump-submit","/att/attSignInOut/jump2Task2",taskId,bizId,_csrf);
        });
        //清除事件(用于在办列表详情)
        //clearEvent();
        //常用意见列表
        fixed.opinionList();
        /*下拉多选初始化*/
        multselInit();
        /*检查任务是否已被签收*/
        fixed.checkClaim(taskId,_csrf);
        detail(bizId);
        //考勤补签详情
        function detail(bizId) {
            var param = {
                _csrf:_csrf,
				ids : bizId,
				taskId : taskId,
				processId : processInstanceId
			}

            tool.post("/att/attSignInOut/getSignInOutPatchList",param,function(response){
                if(response.code == 0){
                    var  obj = response.object;
                    var patchlist={patchlist:obj.data};
                    $('#patch-data').html(template("patch-script", patchlist));
                    if(null != obj.attSignInCount){
                        $("#deptName").text(obj.attSignInCount.deptName);
                        $("#signUserName").text(obj.attSignInCount.signUserName);
                        $("#timeqi").text(obj.attSignInCount.time1);
                    }
                }
            },false);
        }

        /*切换按钮  */
		function change_btn(){
            fixed.claimTask(taskId,_csrf);
		}
		function agree(){
            $("#form-jump-submit").hide();
            $("#form-add-submit").show();
			$(".agree").show();
			$(".noagree").hide();
			$(".yes").addClass("blue_border");
			$(".no").removeClass("blue_border");	
		}
		function noagree(){
            $("#form-add-submit").hide();
            $("#form-jump-submit").show();
            fixed.getPreTaskInfo(taskId,_csrf);
            $(".yes").removeClass("blue_border");
            $(".no").addClass("blue_border");
        }
		//审批弹窗
		function yes() {
			//考勤为分支流程
			getNextTask1(taskId,_csrf);
			var nextStept = $("#nextStept").val();
		}
		/* 日志 */
		function daily(){
            fixed.getAllTaskLogInfo("/att/attSignInOut/getAllTaskInfo",taskId,_csrf);
		}
		/* 常用意见 */
		function suggest(){
			var index = layer.open({
				title : '填写意见',
				maxmin : false,
				type : 1,
				shadeClose: true,
                area: ['900px', '510px'],
				content : $('#win-suggest-object')
			});
			/* layer.full(index); */
		}
		//点击添加常用意见
		function click_font(obj){
			var a = $(obj).find('.sug').text();
			/* var b = $('#draw_sug').val(); */
			$('#draw_sug').val(a);
		}	
		function add_sug(){
			layer.confirm('确定加入常用意见？', {
				  icon:3,
				  btn: ['确定','取消'] //按钮
				}, function(){
                	fixed.addOpinion();
				}, function(){
				  
				});
		}
		   //人员选择树
		function personlSeclectOpen(){
			var openType = $("#openType").val();
			var deptId = $("#deptId").val();
			var uId = $("#deptUserId").val();
			if(openType == "3"){
				/* 选择受理人和候选用户，有选择部门时，弹出组织机构数 */
				//tool.treeDemo("win-personal-object",'treeDemo',"n_receiverNameid","n_receiverName_","n_receiverName",false,"",deptId,"","",uId);
				tool.treeDemo("win-personal-object",'treeDemo',"n_receiverNameid","","n_receiverName",false,"",$("#deptId").val());
			}else{
				/* 未选择受理人和候选用户，包含选择后找不到对应的办理或候选用户，弹出组织机构树，优先级最高 */
				tool.treeDemo("win-personal-object","treeDemo","n_receiverNameid","n_receiverName_","n_receiverName",false,"","","","");
			}  
			$("#number").html("");
      	}
        //用按钮查询节点  
       /*  function searchNodes(){  
             var mytree = $.fn.zTree.getZTreeObj("treeDemo");
            var keywords=$("#peopelSel").val();  
            var nodes = mytree.getNodesByParamFuzzy("name", keywords, null);  
            if (nodes.length>0) {  
                mytree.selectNode(nodes[0]);  
            }  
        }  */ 
		//重置树
		function reset_tree(){
			var mytree = $.fn.zTree.getZTreeObj("treeDemo");
		    //打开弹窗前重置节点以及关闭展开状态，避免叠加
		    $("#number").html("");
			$('.reset').val("");
			$('.reset1').html("");
			mytree.checkAllNodes(false)
		    mytree.expandAll(false);
		}

        //流程作废
        $("#void-process").on("click",function () {
            if($("#processInstanceId").val() == '') {
                fixed.voidProcess("/att/attSignInOut/void", taskId, bizId, _csrf);
            }
        });

        function clearEvent() {
            if($("#processInstanceId").val() != ''){
                $("#btns").find("a").each(function (index) {
                    $(this).removeAttr("onclick");
                });
            }
        }
        
        
        //分支流程获取下一节点信息
        function getNextTask1(taskId,_csrf) {
	        var pm = {
	            taskId:taskId,
	            _csrf:_csrf
	        };
	        tool.post("/att/attSignInOut/getNextTaskInfo",pm,function(retMsg){
				var taskList = retMsg.object.taskDefinitionList	
				var nextStept = retMsg.object.nextStept	
				$("#nextStept").val(nextStept);
	            var nextNodeName = "";
	            if(taskList.length == 0){
	                nextNodeName = "结束";
	                $("#audit-orgn").hide();
	                $("#audit-member").hide();
	                $("#isNotEnd").val("0");//值为0是结束节点
	                getpreTaskInfo();	                
	            }else{
	                var data = taskList[0];
	                nextNodeName = data.nextNodeName;
	                fixed.checkNextTaskInfo("/att/attSignInOut/checkNextTaskInfo",taskId,_csrf,nextStept);
	            }
	            $("#nextNode").empty();
	            //$("#nextNode").append('<option value="">请选择</option>');
	            $("#nextNode").append('<option value="\'+nextNodeName+\'" selected="selected" readonly="readonly">'+nextNodeName+'</option>');
	            if(retMsg.code == 0){
	                var index = layer.open({
	                    title : '审批处理',
	                    maxmin : false,
	                    type : 1,
	                    area: ['900px', '510px'],
	                    shadeClose: true,
	                    content : $('#win-suggest-object')
	                });
	                pform.render();
	            }
	        },false);
	    }
        
        function getpreTaskInfo(){
            var url = "/pub/pubPublicInfo/getPreTaskInfo";
            var pm = {
                taskId:taskId,
                _csrf:_csrf
            };
            tool.post(url,pm,function(retMsg){
            	if(retMsg.object.length == 0 ){
            		$("#no_agree_btn").hide()
            	}
            },false)
        }
	</script>
</body>
</html>
